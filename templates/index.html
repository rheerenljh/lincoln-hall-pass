<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lincoln Jr. High Hall Pass</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f7f7f7; }
    header { background-color: #000; padding: 20px; text-align: center; color: white; }
    header img { max-height: 80px; vertical-align: middle; }
    h1 { color: #c8102e; margin-top: 10px; }
    .container { max-width: 600px; background: white; padding: 30px; margin: 30px auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-top: 5px solid #c8102e; }
    form { display: flex; flex-direction: column; }
    label { margin-top: 15px; font-weight: bold; }
    input, select { padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
    button { margin-top: 20px; padding: 10px; background-color: #c8102e; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
    button:hover { background-color: #9d0c21; }
    .sign-in-form { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; }
    .student-counter { margin-top: 10px; font-weight: bold; }
    .error-banner { background:#ffe5e7; color:#9d0c21; border:1px solid #f3b3b8; padding:10px 12px; border-radius:4px; margin-bottom:15px; }
    .notice { background:#eef6ff; color:#123; border:1px solid #b7d0ff; padding:10px 12px; border-radius:4px; margin-bottom:15px; }
    small.helper { color:#555; margin-top:4px; }
    .sr-only { position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden; }
  </style>
  <script>
    function toggleOtherReason() {
      const reasonDropdown = document.getElementById("reason");
      const otherReasonInput = document.getElementById("other-reason-field");
      otherReasonInput.style.display = (reasonDropdown.value === "Other") ? "block" : "none";
    }
    window.addEventListener('DOMContentLoaded', () => {
      toggleOtherReason(); // set initial visibility based on current value
    });
  </script>
</head>
<body>

  <header>
    <img src="{{ url_for('static', filename='lincoln_logo.png') }}" alt="Lincoln Jr. High School Logo">
    <h1>Lincoln Jr. High Hall Pass</h1>
  </header>

  <div class="container">

    {# Quarter / limit context from context_processor #}
    {% if CURRENT_QUARTER %}
      <div class="notice">
        {% if CURRENT_QUARTER == 'Unknown' %}
          No active quarter (e.g., break day). Passes won’t count toward limits until school resumes.
        {% else %}
          Current Quarter: {{ CURRENT_QUARTER }} • Pass limit: {{ MAX_QUARTER_PASSES|default(18) }}
        {% endif %}
      </div>
    {% endif %}

    {# Error area with specific hints based on error_code #}
    {% if error %}
      <div class="error-banner" role="alert" aria-live="polite">
        {{ error }}
        {% if error_code == 'capacity' %}
          <div><small class="helper">All spots are currently taken. Please try again when someone returns.</small></div>
        {% elif error_code == 'limit_reached' %}
          <div><small class="helper">You’ve reached your {{ MAX_QUARTER_PASSES|default(18) }}-pass limit for {{ CURRENT_QUARTER }}. Talk to your teacher if you think this is a mistake.</small></div>
        {% elif error_code == 'no_quarter' %}
          <div><small class="helper">Sign-outs resume on the next school day of the new quarter.</small></div>
        {% elif error_code == 'pin_required' %}
          <div><small class="helper">Tip: Use digits only (e.g., 0 1 2 3). Include leading zeros.</small></div>
        {% elif error_code == 'pin_mismatch' %}
          <div><small class="helper">Check spelling of your first/last name and the last 4 digits (include leading zeros). If it still fails, ask your teacher to verify the roster.</small></div>
        {% endif %}
      </div>
    {% endif %}

    {# Student usage status (dynamic colors, dynamic limit) #}
    {% if used_passes is not none %}
      {% set maxp = MAX_QUARTER_PASSES|default(18) %}
      {% set color = 'green' %}
      {% if used_passes >= (maxp * 2) // 3 %}
        {% set color = 'red' %}
      {% elif used_passes >= maxp // 3 %}
        {% set color = 'orange' %}
      {% endif %}
      <p class="student-counter">
        Hello, {{ name }}! You have used
        <span style="color: {{ color }};">{{ used_passes }}</span>
        of {{ maxp }} passes this quarter{% if CURRENT_QUARTER and CURRENT_QUARTER != 'Unknown' %} ({{ CURRENT_QUARTER }}){% endif %}.
      </p>
    {% endif %}

    <!-- SIGN OUT -->
    <form method="POST" action="{{ url_for('signout') }}" novalidate>
      <label for="first_name">First Name:</label>
      <input
        type="text"
        id="first_name"
        name="first_name"
        list="first-name-list"
        autocomplete="off"
        required
      >
      <datalist id="first-name-list">
        {% for fn in first_name_options %}
          <option value="{{ fn }}"></option>
        {% endfor %}
      </datalist>

      <label for="last_name">Last Name:</label>
      <input
        type="text"
        id="last_name"
        name="last_name"
        list="last-name-list"
        autocomplete="off"
        required
      >
      <datalist id="last-name-list">
        {% for ln in last_name_options %}
          <option value="{{ ln }}"></option>
        {% endfor %}
      </datalist>

      {% if ENABLE_STUDENT_PIN %}
        <label for="pin_out">Student ID (last 4):</label>
        <input
          type="text"
          id="pin_out"
          name="pin"
          maxlength="4"
          pattern="\d{4}"
          inputmode="numeric"
          autocomplete="off"
          required
        >
        <small class="helper">Enter exactly 4 digits. If your ID starts with 0, include the 0.</small>
      {% else %}
        <span class="sr-only">PIN disabled</span>
      {% endif %}

      <label for="period">Period:</label>
      <select id="period" name="period" required>
        <option value="">Select Period</option>
        {% for period in periods %}
          <option value="{{ period }}">{{ period }}</option>
        {% endfor %}
      </select>

      <label for="teacher">Teacher:</label>
      <select id="teacher" name="teacher" required>
        <option value="">Select Teacher</option>
        {% for teacher in teachers %}
          <option value="{{ teacher }}">{{ teacher }}</option>
        {% endfor %}
      </select>

      <label for="reason">Reason:</label>
      <select id="reason" name="reason" onchange="toggleOtherReason()" required>
        <option value="">Select Reason</option>
        {% for r in reasons %}
          <option value="{{ r }}">{{ r }}</option>
        {% endfor %}
      </select>

      <div id="other-reason-field" style="display: none;">
        <label for="other_reason">Enter custom reason:</label>
        <input type="text" id="other_reason" name="other_reason" autocomplete="off">
      </div>

      <button type="submit">Sign Out</button>
<small class="helper" aria-live="polite">
  Tap “Sign Out” once. It may take a few seconds to save.
</small>  

    </form>

    <!-- SIGN IN -->
    <div class="sign-in-form">
      <h2>Sign In</h2>
      <form method="POST" action="{{ url_for('signin') }}">
        <label for="name">Full Name (First Last):</label>
        <input type="text" id="name" name="name" required autocomplete="off">
        <button type="submit">Sign In</button>
      </form>
    </div>

    <p style="margin-top: 30px;"><a href="{{ url_for('login') }}">Teacher Login</a></p>
  </div>

  <!-- ...your page content... -->

  <!-- Prevent double-submit on Sign Out -->
  <!-- Prevent double-submit on Sign Out -->
  <script>
    (function () {
      const form = document.querySelector('form[action="{{ url_for("signout") }}"]');
      if (!form) return;
      const btn = form.querySelector('button[type="submit"]');

      form.addEventListener('submit', function (e) {
        if (btn.dataset.locked === '1') { e.preventDefault(); return false; }
        btn.dataset.locked = '1';
        btn.disabled = true;
        btn.setAttribute('aria-busy', 'true');
        btn.textContent = 'Processing… please wait';
      });
    })();
  </script>
</body>
</html>

